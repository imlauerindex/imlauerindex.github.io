<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Buffer overflow exámen 5 (Ricardo Narvaja Reversing) | Index</title>
<meta name="robots" content='index, follow'>
<meta name="description" content="">
<meta name="generator" content="hugo-index">
<link crossorigin="anonymous" href="https://adityatelange.github.io/assets/stylesheet.css" rel="preload stylesheet" as="style">
<script crossorigin="anonymous" src="https://adityatelange.github.io/assets/quicklink.js" rel="preload" as="script"></script>
<script>
    window.addEventListener('load', () => {
        quicklink.listen();
    });
</script>

  </head>
  <body><header>
  <h1>
    <a href="https://adityatelange.github.io/">
      <img src="https://adityatelange.github.io/index.png" alt="Index">
      <span>Index</span>
    </a>
    <span class="hl">/</span>
    <a href="https://adityatelange.github.io/bufferoverflow_5/">
      <span>Buffer overflow exámen 5 (Ricardo Narvaja Reversing)</span>
    </a>
  </h1>
  <p class="desc"></p>
</header>
<div class="main">

<ul class="tagsList single">
  
  <li><a href="https://adityatelange.github.io/@ricardo/">Ricardo</a></li>
  
  <li><a href="https://adityatelange.github.io/@narvaja/">Narvaja</a></li>
  
  <li><a href="https://adityatelange.github.io/@cracking/">Cracking</a></li>
  
  <li><a href="https://adityatelange.github.io/@examen/">Examen</a></li>
  
  <li><a href="https://adityatelange.github.io/@buffer/">Buffer</a></li>
  
  <li><a href="https://adityatelange.github.io/@overflow/">Overflow</a></li>
  
  <li><a href="https://adityatelange.github.io/@ida/">Ida</a></li>
  
  <li><a href="https://adityatelange.github.io/@reversing/">Reversing</a></li>
  
</ul>

<div class="content"><p>Lo que el decompilador de IDA me generó con algunas modificaciones.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">check</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Copia el buffer a partir de la posición 216 al comienzo del buffer a partir de la posición 4.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 11 caracteres insertando al buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 4+4+11 = 19
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">savedregs</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// 199 -4 + 11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="s">&#34;Bien ? con %s&#34;</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+</span> <span class="mi">216</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 52-19 = 33
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// La posición 33 del archivo example.txt tiene que ser igual a el hexadecimal 45 (&#39;E&#39;).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">52</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x45</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Mal camino </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xD</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;valor= %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;number= %x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">204</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 51-19 = 32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// La posición 32 del archivo example.txt tiene que ser igual a el hexadecimal 44.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">51</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x46</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Noooo, %x </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">204</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Aprobaste level 5&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="mi">416</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">buffer</span><span class="p">[</span><span class="mi">51</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">buffer</span><span class="p">[</span><span class="mi">52</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;E&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Inicializa el buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">216</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">buffer</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="s">&#34;example.txt&#34;</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">buffer</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;No se puede leer el archivo bye bye </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Carga a partir de la posición 216 el contenido del archivo.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 216-53 = 163
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 216+163 = 379
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 416-216 = 200
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">fread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">216</span><span class="p">],</span> <span class="mi">200</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span> <span class="mi">1</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">53</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Copia el buffer a partir de la posición 216 al comienzo del buffer a partir de la posición 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nf">strcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">216</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// El carácter de la posición 47 del texto example.txt tiene que ser igual 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">51</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Mal </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">check</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Primero pasamos el primer if.
Agregamos las 4 As al comienzo para saber cual es la posición 51, hasta 190 caracteres.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">AAAAPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP1PPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP
</span></span></code></pre></div><p>Luego eliminamos las As y agregamos otra vez 4 As y 11 caracteres al comienzo</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">AAAA12345678911PPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPDEPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP
</span></span></code></pre></div><p>Luego eliminamos las As y los 11 caracteres.</p>
<h4 id="exploit">exploit:</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">00000000: 4444 4444 4444 4444 4444 4444 4444 4444  DDDDDDDDDDDDDDDD
</span></span><span class="line"><span class="cl">00000010: 4444 4444 4444 4444 4444 4444 4444 4444  DDDDDDDDDDDDDDDD
</span></span><span class="line"><span class="cl">00000020: 4444 4444 4544 4444 4444 4444 4444 3144  DDDDEDDDDDDDDD1D
</span></span><span class="line"><span class="cl">00000030: 4444 4444 4444 4444 4444 4444 4444 4444  DDDDDDDDDDDDDDDD
</span></span><span class="line"><span class="cl">00000040: 4444 4444 4444 4444 4444 4444 4444 4444  DDDDDDDDDDDDDDDD
</span></span><span class="line"><span class="cl">00000050: 4444 4444 4444 4444 4444 4444 4444 4444  DDDDDDDDDDDDDDDD
</span></span><span class="line"><span class="cl">00000060: 4444 4444 4444 4444 4444 4444 4444 4444  DDDDDDDDDDDDDDDD
</span></span><span class="line"><span class="cl">00000070: 4444 4444 4444 4444 4444 4444 4444 4444  DDDDDDDDDDDDDDDD
</span></span><span class="line"><span class="cl">00000080: 4444 4444 4444 4444 4444 4444 4444 4444  DDDDDDDDDDDDDDDD
</span></span><span class="line"><span class="cl">00000090: 4444 4444 4444 4444 4444 4444 4444 4444  DDDDDDDDDDDDDDDD
</span></span><span class="line"><span class="cl">000000a0: 4444 4444 4444 4444 4444 4444 4444 4444  DDDDDDDDDDDDDDDD
</span></span><span class="line"><span class="cl">000000b0: 4444 4444 4444 4444 4444 4444 4444       DDDDDDDDDDDDDD
</span></span></code></pre></div></div></div><footer>
    <hr>
    <div class="footer-text">
        <div>© 2024 Index</div>
        <div>Powered by <a href="https://gohugo.io/">Hugo</a> & <a
                href="https://github.com/adityatelange/hugo-index/">Index</a></div>
    </div>
</footer>
</body>
</html>
